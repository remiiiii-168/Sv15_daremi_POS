<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daremi POS screen</title>
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="stylesheet" href="style.css">
</head>



<body>
    <div class="container-fluid"> 
        <div class="row">
            <div class="col-7" >
                <div class="row" id="main_product_card">
                </div>
            </div>
            <div class="col-5 mt-3">
                 <div class="card Product-Card " >
                    <div class="card-header">
                        <h3>Select Product</h3>
                        </div>
                            <div class="card-body p-1">
                                <div class="table-responsive">
                                    <table class="table table-borderless table-striped">
                                        <thead class=" bg-primary text-white ">
                                            <tr>
                                                <th>No.</th>
                                                <th>Name</th>
                                                <th>Price</th>
                                                <th>Quantity</th>
                                                <th>total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id = "Select_product_tr_box">
                                        </tbody>
                                    </table>

                                </div>
                                <div class="card-footer">
                                        <table class="table table-bordered">

                                            <!-- total -->
                                                <tr>
                                                    <th>
                                                        <h3>Total :</h3>
                                                    </th>
                                                    <th style="text-align: right;">
                                                        <h3 id="total_usd">$ 0<h3>
                                                        <h3 id="total_khr">៛ 0<h3>
                                                    </th>
                                                </tr>
                                                <!-- recevived -->
                                                <tr>
                                                    <th>
                                                        <h3>Received :</h3>
                                                    </th>
                                                    <th style="text-align: left;">
                                                        <input style="      font-size: 50px;
                                                                            height: 55px;
                                                                            width: 100%;
                                                                            color: navy;
                                                                            text-align: right;" type="number" value=""
                                                        type="number"
                                                        id="recevived"
                                                        onkeyup="getChangeAmout()">
                                                    </th>
                                                </tr>
                                                <!-- chgange -->
                                                <tr >
                                                    <th>
                                                        <h3>chgange :</h3>
                                                    </th>
                                                    <th style="text-align: right;">
                                                        <h3 style="font-size: 50px;
                                                                display: none;
                                                                height: 55px;
                                                                width: 100%;
                                                                color: dark red;
                                                                background-color: gainsboro;
                                                                text-align: right;" type="number" value=""
                                                        
                                                        id="change_amount"
                                                        >
                                                        
                                                    </h3>
                                                        
                                                    </th>
                                                </tr>
                                                <!-- btn -->
                                                <tr>
                                                    <th>
                                                        <input onclick="cancel()" style="height: 70px; font-size: 40px; text-align: center;" type="button" value="Cancel" id="btn_cancel" class="btn-danger">
                                                    </th>
                                                    <th>
                                                        
                                                        <input style="height: 70px; font-size: 40px; text-align: center;" type="button" value=" Pay Now " id="btn_Pay" class="btn-primary w-100" >
                                                    </th>
                                                </tr>
                                        </table>
                                </div>            
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </body>



<script>
    let products = JSON.parse(localStorage.getItem('products') ?? '[]');
    let Selected_Product = []
    let main_product_card = document.getElementById('main_product_card')
    let Select_product_tr_box = document.getElementById('Select_product_tr_box')
    let btn_Pay = document.getElementById('btn_Pay')
    let input_recevived = document.getElementById('recevived')
    let total = 0

    let change_amount = 0
    rederProductCard()


    function rederProductCard() {


        let html_card = ''
        products.forEach(( product , index ) => {
            html_card += `
            
            <div class="col-3 mt-3" onclick = "CardOnClick(${index})">
                        <div class="card Product-Card " >
                            <center>
                                <img src="${product.picture}" 
                                class="card-img-top product-picture" 
                                alt="Sting">
                            </center>
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.price} </p>
                                
                               
                            </div>
                        </div>
                    </div>
            `
                    main_product_card.innerHTML = html_card
        })
    }

    function rederSelectProduct(){
        let Select_product_tr = '';
        Selected_Product.forEach((product, index) => {
        let total = product.price * product.Quantity;
        Select_product_tr += `
        <tr>
            <td>${index + 1}</td>
            <td>${product.name}</td>
            <td>${product.price}$</td>
            <td>${product.Quantity}</td>
            <td>${total.toFixed(2)}$</td>
            <td><a onclick="deleteItem(${index})" href="#" class="btn btn-sm btn-outline-secondary">X</a></td>
            </tr>
            `;
    });

    Select_product_tr_box.innerHTML = Select_product_tr;
    } 

    function CardOnClick(index) {
    let current_product = { ...products[index] }; 
    let dpl_index = null;

    
    for (let i = 0; i < Selected_Product.length; i++) {
        if (current_product.name === Selected_Product[i].name) {
            dpl_index = i;
            break;
        }
    }

    if (dpl_index !== null) {
        
        Selected_Product[dpl_index].Quantity += 1;
    } else {
        
        current_product.Quantity = 1;
        Selected_Product.push(current_product);
    }

    rederSelectProduct()
    get_total()
}

    function deleteItem(index){
        let del_confirm = confirm('Are you sure!!! Do you want to delete this product ??')
        if(del_confirm){

            Selected_Product.splice(index,1)
            rederSelectProduct()

        }
    }
        
    function get_total() {
        total = 0; 
        Selected_Product.forEach((product) => {
            total += product.price * product.Quantity;
        });

        document.getElementById('total_usd').innerText = "$ " + total.toFixed(2);
        document.getElementById('total_khr').innerText = "៛ " + (total * 4150).toLocaleString();
}

    btn_Pay.addEventListener('click' ,(e) => { 
        let recevived = input_recevived.value
        if(parseFloat(recevived) <  total || parseFloat(recevived) == null){
            alert("Don't have enough money to pay !!! ")
            return
        }
        localStorage.setItem('products', JSON.stringify(products))
            let width = 600
            let height = 600
            let left = (window.screen.width - width) / 2;
            let top = (window.screen.height - height) / 2;
            window.open(
                'invoice.html',
                '_blank',
                `width=600,height=600,
                left=${left},
                top=${top}`
)

    })

    function getChangeAmout() {
        let label_change_amount = document.getElementById('change_amount');
        let recevived = parseFloat(input_recevived.value) || 0;
        let change_amount = recevived - total;

        if (change_amount >= 0) {
            label_change_amount.innerText = "$ " + change_amount.toFixed(2);
            label_change_amount.style.display = 'block';
        } else {
            label_change_amount.innerText = '';
            label_change_amount.style.display = 'none';
        }
}

    function cancel(){
        if(confirm("Aree you sure !! Do you want to delete this product ???"))
        total =  0
        Selected_Product = []
        rederSelectProduct()
        get_total()
        document.getElementById('recevived').value = 0
        document.getElementById('change_amount').innerText = ''
        document.getElementById('change_amount').style.display = 'none'
    }

</script>

</html>